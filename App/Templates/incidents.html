{% extends "base.html" %}
{% block content %}
<h2>Citizen Incidents</h2>
<div class="card">
  <form id="incidentForm">
    <label>Description:</label><br>
    <input type="text" name="description" style="width:100%" required><br><br>
    <label>Latitude:</label><br>
    <input type="number" step="any" name="lat" required><br><br>
    <label>Longitude:</label><br>
    <input type="number" step="any" name="lng" required><br><br>
    <label>Photo URL (optional):</label><br>
    <input type="url" name="photoUrl" style="width:100%"><br><br>
    <button class="btn" type="submit">Report Incident</button>
  </form>
</div>

<div class="card">
  <h3>All Incidents</h3>
  <table id="incidentTable">
    <thead><tr><th>ID</th><th>Ward</th><th>Type</th><th>Status</th><th>Description</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
async function loadIncidents(){
  const res = await fetch('/api/incidents');
  const data = await res.json();
  const tbody = document.querySelector('#incidentTable tbody');
  tbody.innerHTML = '';
  data.items.forEach(it => {
    tbody.innerHTML += `<tr><td>${it.id}</td><td>${it.ward}</td><td>${it.type}</td><td>${it.status}</td><td>${it.description}</td></tr>`;
  });
}
loadIncidents();

document.querySelector('#incidentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.target;
  const payload = {
    description: form.description.value,
    lat: parseFloat(form.lat.value),
    lng: parseFloat(form.lng.value),
    photoUrl: form.photoUrl.value || null
  };
  const res = await fetch('/api/incidents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  if(res.ok){ alert('Incident reported!'); loadIncidents(); form.reset(); }
  else { alert('Error submitting.'); }
});
</script>
{% endblock %}
